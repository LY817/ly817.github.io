事务是**一组**数据操作处理的动作集合，事务具备

一组处理步骤或者全部发生或者一步也不执行，我们称该组处理步骤为一个事务。

* 提交：当所有的步骤像一个操作一样被完整地执行，我们称该事务被提交。

* 回滚：由于其中的一部分或多步执行失败，导致没有步骤被提交，则事务必须回滚到最初的系统状态。

# 本地事务

在单体系统中，可以通过本地事务来保证事务的完整性

### SQL事务

以MySQL为例简要说明

* `BEGIN` 来开启一个事务
* `ROLLBACK` 事务回滚
*  事务提交

### Spring事务支持

为方法添加`@Transactional`注解，**利用AOP**

* 为方法中所有数据库操作开启事务 `begin`
* 当方法执行出现指定异常时，执行事务回滚 `ROLLBACK` 
* 当方法正常执行完毕后，将事务提交 `COMMIT`

# 分布式事务

分布式系统中，一个事务中的执行步骤分布在不同进程中，数据保存在不同的数据库中，无法使用上述的本地事务

## 角色

### AP 应用程序

应用程序，可以理解为使用DTP（Data Tools Platform）的程序

### RM 资源管理器

资源管理器，这里可以是一个DBMS或者消息服务器管理系统，应用程序通过资源管理器对资源进行控制，资源必须实现XA定义的接口。资源管理器负责控制和管理实际的资源

### TM 事务管理器

事务管理器，负责协调和管理事务，提供给AP编程接口以及管理资源管理器。事务管理器控制着全局事务，管理事务的生命周期，并且协调资源。

## 协议

### TX协议

应用或者应用服务器与事务管理器的接口。

### XA协议

全局事务管理器与资源管理器的接口。XA是由X/Open组织提出的分布式事务规范。该规范主要定义了全局事务管理器和局部资源管理器之间的接口。主流的数据库产品都实现了XA接口。XA接口是一个双向的系统接口，在事务管理器以及多个资源管理器之间作为通信桥梁。之所以需要XA是因为在分布式系统中从理论上讲两台机器是无法达到一致性状态的，因此引入一个单点进行协调。由全局事务管理器管理和协调的事务可以跨越多个资源和进程。全局事务管理器一般使用XA二阶段协议与数据库进行交互。

### 两阶段提交协议

XA用于在全局事务中协调多个资源的机制。TM和RM之间采取两阶段提交的方案来解决一致性问题。两节点提交需要一个协调者（TM）来掌控所有参与者（RM）节点的操作结果并且指引这些节点是否需要最终提交。两阶段提交的局限在于协议成本，准备阶段的持久成本，全局事务状态的持久成本，潜在故障点多带来的脆弱性，准备后，提交前的故障引发一系列隔离与恢复难题。

## 柔性事务

柔性状态是指允许系统存在中间状态，这个中间状态不会影响系统整体的可用性，比如数据库读写分离的主从同步延迟等。柔性事务的一致性指的是最终一致性

### 特点

#### 操作可查询

每一个服务操作都被存储为dolog，具有全局唯一的标识，操作唯一的确定的时间，可以被查询。

#### 可补偿操作

Do阶段：真正的执行业务处理，业务处理结果外部可见。

Compensate（补偿 redo）阶段：抵消或者部分撤销正向业务操作的业务结果，补偿操作满足幂等性。

> 约束：补偿操作在业务上可行，由于业务执行结果未隔离或者补偿不完整带来的风险与成本可控。实际上，TCC的Confirm和Cancel操作可以看做是补偿操作。

#### 幂等操作

重复调用多次产生的业务结果与调用一次产生的结果相同。一是通过业务操作实现幂等性，二是系统缓存所有请求与处理的结果，最后是检测到重复请求之后，自动返回之前的处理结果。

### 两阶段提交（2PC）

> 两阶段提交协议（Two-phase Commit，2PC）

协调器（使用分布式锁的思想：在一个公共内存中维护共有资源的占用状态）和若干事务执行者（分布式服务实例）两种角色

* 第一阶段是**表决阶段**，所有参与者都将本事务能否成功的信息反馈发给协调器；

* 第二阶段是**执行阶段**，协调者根据所有参与者的反馈，通知所有参与者，步调一致地在所有分支上提交或者回滚。

![img](assets\1334519-20180307150636190-1704712093.png)

### TCC事务

TCC方案其实是两阶段提交的一种改进。其将整个业务逻辑的每个分支显式的分成了Try、Confirm、Cancel三个操作。Try部分完成业务的准备工作，confirm部分完成业务的提交，cancel部分完成事务的回滚

- Try阶段：尝试执行业务，完成所有业务的检查，实现一致性；预留必须的业务资源，实现准隔离性。
- Confirm阶段：真正的去执行业务，不做任何检查，仅适用Try阶段预留的业务资源，Confirm操作还要满足幂等性。
- Cancel阶段：取消执行业务，释放Try阶段预留的业务资源，Cancel操作要满足幂等性。

> TCC与2PC(两阶段提交)协议
>
> 区别：TCC位于业务服务层而不是资源层，TCC没有单独准备阶段，Try操作兼备资源操作与准备的能力，TCC中Try操作可以灵活的选择业务资源，锁定粒度。TCC的开发成本比2PC高。实际上TCC也属于两阶段操作，但是TCC不等同于2PC操作。
>
> 缺点：性能太差，两阶段提交涉及多次节点间的网络通信，通信时间太长； 事务时间相对于变长了，锁定的资源的时间也变长了，造成资源等待时间也增加好多。

![img](assets\1334519-20180307150648591-1729601878.png)

---

## 事务消息

### 可靠消息服务



### RocketMQ事务消息

RocketMQ中提供一种特殊状态的消息



# 参考

https://www.jianshu.com/p/cc5c10221aa1

https://www.cnblogs.com/jiangyu666/p/8522547.html

https://www.cnblogs.com/bluemiaomiao/p/11216380.html