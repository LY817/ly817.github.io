通过**可靠消息机制**达到数据的最终一致性

> 柔性事务替代分布式事务框架将事务状态保持在中心节点
>
> 分布式事务框架 考虑的是失败回滚
>
> 可靠消息柔性事务 是通过失败重试 必须保证事务执行完成

## 可靠消息

可靠消息投递成功，就保证消息一定能被成功消费

> 从接口调用方的角度，如果这个使用了可靠消息的事务方法正常返回了，就表示操作成功。至于具体如何成功，交给后续的重试机制和消费方法逻辑来搞定。

### 如何保证消息的“可靠”

- **本地事务**：每一个可靠消息控制的操作是一个可以回滚的本地事务（不能进行远程调用）

- **原子性**：本地事务与消息发送保持同步

  消息与本地事务同步，保证本地事务操作和消息发送一致，同时成功或者失败

- **可靠性**：重试机制，保证异常情况下，导致消费失败

- **幂等性**：消费逻辑需要做到幂等

  由于消息消费端网络超时，可能会出现消息消费成功但是服务端没有收到消费成功的返回，导致重复投递消息

  需要在消费端做好幂等性检查

### RocketMQ Half-message实现



> 因为网络的不可靠，无法通过普通消息来实现
>
> - 如果先执行本地事务，可能本地事务执行成功了，但是消息发送失败
> - 如果先执行发送消息，可能后续的本地事务执行失败

### 消息日志表

插入消息日志到数据库，参与本地事务，本地事务执行成功会插入一条消息日志到数据库。另外有一个定时任务扫描消息日志表，将执行成功的消息日志发送到mq。保证本地事务和日志消息发送一致

> 用于不支持事务的MQ